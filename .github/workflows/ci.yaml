name: Race Monitor CI

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]
    paths:
      - 'Dockerfile'
      - 'requirements.txt'
      - 'constraints.txt'
      - '.github/workflows/ci.yaml'
  schedule:
    - cron: "0 0 * * *" # daily at midnight UTC
  workflow_dispatch:

env:
  ROS_DISTRO: humble
  REGISTRY: ghcr.io
  IMAGE_NAME: giu-f1tenth/race-monitor-ci

jobs:
  check-docker-changes:
    name: Check if Docker rebuild needed
    runs-on: ubuntu-22.04
    outputs:
      docker-changed: ${{ steps.filter.outputs.docker }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
        
      - name: Check for Docker-related changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docker:
              - 'Dockerfile'
              - 'requirements.txt'
              - 'constraints.txt'
              - '.github/workflows/ci.yaml'

  docker-build:
    name: Build Ubuntu-ROS2-Docker Image
    runs-on: ubuntu-22.04
    needs: check-docker-changes
    # Only build and push Docker images for PRs and main/dev branches
    # Skip for random commits to feature branches and scheduled runs
    if: |
      needs.check-docker-changes.outputs.docker-changed == 'true' &&
      (github.event_name == 'pull_request' || 
       github.ref == 'refs/heads/main' || 
       github.ref == 'refs/heads/dev')
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Generate safe Docker tag
        id: image-tag
        run: |
          # Generate a safe tag without slashes
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, use pr-NUMBER format
            TAG="pr-${{ github.event.pull_request.number }}"
          else
            # For branches, sanitize the ref name
            TAG="${{ github.ref_name }}"
            TAG="${TAG//\//-}"  # Replace / with -
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated Docker tag: ${TAG}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }}
            ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') && format('{0}/{1}:{2}', env.REGISTRY, env.IMAGE_NAME, github.ref_name) || '' }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  python-lint:
    name: Python Code Quality
    runs-on: ubuntu-22.04
    if: always() && !cancelled()
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt','**/constraints.txt') }}

      - name: Install Python dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -c constraints.txt -r requirements.txt

      - name: Lint with flake8
        run: |
          flake8 race_monitor/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 race_monitor/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Type check with mypy
        continue-on-error: true
        run: |
          mypy --ignore-missing-imports \
               --allow-untyped-defs \
               --no-strict-optional \
               --allow-untyped-calls \
               --allow-incomplete-defs \
               race_monitor/ || echo "Type checking completed with warnings"

      - name: Security audit
        continue-on-error: true
        run: |
          echo "Running security audit with pip-audit..."
          pip-audit -r requirements.txt || echo "Security audit completed"

  linux-ros2-build:
    name: Test Race Monitor Pkg
    runs-on: ubuntu-22.04
    needs: [python-lint, check-docker-changes, docker-build]
    if: always() && needs.python-lint.result == 'success'
    container:
      # Use the newly built image if available, otherwise fallback to dev/main
      image: ${{ needs.docker-build.result == 'success' && format('ghcr.io/giu-f1tenth/race-monitor-ci:{0}', needs.docker-build.outputs.image-tag) || (github.event_name == 'pull_request' && 'ghcr.io/giu-f1tenth/race-monitor-ci:dev') || 'ghcr.io/giu-f1tenth/race-monitor-ci:main' }}
      options: --user root
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Source ROS2
        shell: bash
        run: |
          source /opt/ros/humble/setup.bash

      - name: Set up workspace structure
        shell: bash
        run: |
          mkdir -p ws/src/race_monitor
          # Copy all files directly to race_monitor package directory
          shopt -s dotglob
          for item in *; do
            if [ "$item" != "ws" ]; then
              cp -r "$item" ws/src/race_monitor/
            fi
          done

      - name: Verify ROS2 environment
        shell: bash
        run: |
          echo "=== Starting ROS2 Environment Verification ==="
          
          # Verify rosdep is initialized
          if [ ! -d "/etc/ros/rosdep" ]; then
            echo "‚ö†Ô∏è  rosdep not initialized, initializing now..."
            rosdep init || echo "rosdep already initialized"
          else
            echo "‚úì rosdep already initialized"
          fi
          
          # Update rosdep
          echo "=== Updating rosdep ==="
          rosdep update || echo "rosdep update completed"
          
          echo ""
          echo "=== Testing Python import WITH ROS2 sourcing ==="
          bash -c "source /opt/ros/humble/setup.bash && python3 -c 'import tf_transformations; print(\"‚úì tf_transformations available\")'" || {
            echo "‚úó tf_transformations import failed, installing alternatives..."
            pip3 install transforms3d
            echo "‚úì transforms3d installed as alternative"
          }
          
          echo ""
          echo "=== ROS2 Environment Verification Complete ==="

      - name: Build package
        shell: bash
        run: |
          cd ws
          echo "=== Starting colcon build ==="
          
          source /opt/ros/humble/setup.bash
          
          echo "=== Building race_monitor package ==="
          colcon build --packages-select race_monitor --cmake-args -DCMAKE_BUILD_TYPE=Release --event-handlers console_direct+
          
          echo ""
          echo "=== Build completed ==="
          ls -la install/ || echo "Install directory not found"

      - name: Run package tests (colcon)
        shell: bash
        run: |
          cd ws
          source /opt/ros/humble/setup.bash
          source install/setup.bash || true

          # Run colcon tests if present
          colcon test --packages-select race_monitor --event-handlers console_direct+ || true
          colcon test-result --verbose || true

      - name: Minimal import & diagnostics
        shell: bash
        run: |
          cd ws
          source /opt/ros/humble/setup.bash
          source install/setup.bash || true
          
          echo "=== Import Diagnostics ==="
          python3 - <<'EOF'
          import sys
          import numpy as np
          
          print('=== Python Environment ===')
          print('Python:', sys.version.splitlines()[0])
          print('NumPy:', np.__version__)
          
          print('')
          print('=== Testing evo import ===')
          try:
              import evo
              print('‚úì evo:', evo.__version__)
          except Exception as e:
              print('‚úó evo import failed:', e)
              raise
          
          print('')
          print('=== Testing transforms3d import ===')
          try:
              import transforms3d
              print('‚úì transforms3d:', transforms3d.__version__)
          except Exception as e:
              print('‚úó transforms3d import failed:', e)
          
          print('')
          print('=== Testing tf_transformations import ===')
          try:
              import tf_transformations
              print('‚úì tf_transformations available')
          except Exception as e:
              print('‚úó tf_transformations import FAILED:', e)
              raise
          
          print('')
          print('=== Testing race_monitor import ===')
          try:
              import race_monitor
              print('‚úì race_monitor import: OK')
          except Exception as e:
              print('‚úó race_monitor import: FAILED', e)
              raise
          
          print('')
          print('=== All imports successful ===')
          EOF

      - name: ROS2 Integration Tests
        shell: bash
        run: |
          cd ws
          source /opt/ros/humble/setup.bash
          source install/setup.bash

          # Smoke pub/sub test
          echo "Running ROS2 pub/sub smoke test..."
          python3 - <<'PY'
          import rclpy
          from rclpy.node import Node
          from std_msgs.msg import String
          import time
          import sys

          try:
              rclpy.init()
              
              class TestNode(Node):
                  def __init__(self):
                      super().__init__('ci_smoke_test')
                      self.pub = self.create_publisher(String, 'ci_test_topic', 10)
                      self.sub = self.create_subscription(String, 'ci_test_topic', self.cb, 10) 
                      self.received = False

                  def cb(self, msg):
                      if msg.data == 'ping':
                          self.received = True

              node = TestNode()
              
              # Give some time for setup
              time.sleep(0.5)
              
              # Publish and check for message reception
              for i in range(5):
                  node.pub.publish(String(data='ping'))
                  rclpy.spin_once(node, timeout_sec=0.5)
                  if node.received:
                      break
                  time.sleep(0.1)

              if not node.received:
                  print('‚úó ROS2 pub/sub smoke test failed: no message loopback')
                  sys.exit(1)
              else:
                  print('‚úì ROS2 pub/sub smoke test passed')
                  
          except Exception as e:
              print(f'‚úó ROS2 pub/sub smoke test failed with error: {e}')
              sys.exit(1)
          finally:
              try:
                  if 'node' in locals():
                      node.destroy_node()
                  if rclpy.ok():
                      rclpy.shutdown()
              except Exception as cleanup_e:
                  print(f'‚úó ROS2 cleanup error: {cleanup_e}')
          PY

      - name: Test Launch File
        shell: bash
        run: |
          cd ws
          
          echo "Testing launch file..."
          timeout 30s bash -c '
            export PATH="/opt/ros/humble/bin:${PATH}"
            source /opt/ros/humble/setup.bash
            source install/setup.bash
            
            ros2 launch race_monitor race_monitor.launch.py &
            LAUNCH_PID=$!
            sleep 20
            if kill -0 $LAUNCH_PID 2>/dev/null; then
              echo "‚úì Launch file started successfully (PID $LAUNCH_PID)"
              kill $LAUNCH_PID || true
              exit 0
            else
              echo "‚úó Launch file failed to start"
              exit 1
            fi
          '

      - name: Test Node Executable
        shell: bash
        run: |
          cd ws

          echo "Testing node executable..."
          timeout 18s bash -c '
            export PATH="/opt/ros/humble/bin:${PATH}"
            source /opt/ros/humble/setup.bash
            source install/setup.bash
            
            ros2 run race_monitor race_monitor &
            NODE_PID=$!
            sleep 12
            if kill -0 $NODE_PID 2>/dev/null; then
              echo "‚úì Node executable started successfully (PID $NODE_PID)"
              kill $NODE_PID || true
              exit 0
            else
              echo "‚úó Node executable failed to start"
              exit 1
            fi
          '

  cleanup-on-failure:
    name: Cleanup Docker Image on Failure
    runs-on: ubuntu-22.04
    needs: [docker-build, linux-ros2-build]
    if: always() && needs.docker-build.result == 'success' && needs.linux-ros2-build.result == 'failure'
    permissions:
      packages: write
    steps:
      - name: Delete failed Docker image
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IMAGE_TAG="${{ needs.docker-build.outputs.image-tag }}"
          PACKAGE_NAME="race-monitor-ci"
          OWNER="giu-f1tenth"
          
          echo "üóëÔ∏è Attempting to delete Docker image: ${OWNER}/${PACKAGE_NAME}:${IMAGE_TAG}"
          
          # Get all versions of the package
          VERSIONS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/${OWNER}/packages/container/${PACKAGE_NAME}/versions" \
            --jq '.[] | select(.metadata.container.tags[] | contains("'${IMAGE_TAG}'")) | .id')
          
          if [ -z "$VERSIONS" ]; then
            echo "‚ö†Ô∏è No matching image found for tag: ${IMAGE_TAG}"
            exit 0
          fi
          
          # Delete each matching version
          for VERSION_ID in $VERSIONS; do
            echo "Deleting version ID: ${VERSION_ID}"
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/orgs/${OWNER}/packages/container/${PACKAGE_NAME}/versions/${VERSION_ID}" \
              && echo "‚úì Deleted version ${VERSION_ID}" \
              || echo "‚ö†Ô∏è Failed to delete version ${VERSION_ID}"
          done
          
          echo "‚úì Cleanup completed for tag: ${IMAGE_TAG}"
